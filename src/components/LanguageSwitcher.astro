---
---

<div class="language-switcher">
  <button class="lang-btn active" data-lang="es" title="EspaÃ±ol">
    <span class="flag">ðŸ‡¨ðŸ‡´</span>
  </button>
  <button class="lang-btn" data-lang="en" title="English">
    <span class="flag">ðŸ‡¬ðŸ‡§</span>
  </button>
  <button class="lang-btn" data-lang="de" title="Deutsch">
    <span class="flag">ðŸ‡©ðŸ‡ª</span>
  </button>
</div>

<style>
  .language-switcher {
    position: fixed;
    top: 1rem;
    left: 1rem;
    display: flex;
    gap: 0.5rem;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.9);
    padding: 0.5rem;
    border-radius: 8px;
    border: 1px solid var(--color-matrix-primary);
    backdrop-filter: blur(10px);
    width: 3.5rem;
    height: 3.5rem;
    overflow: hidden;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    justify-content: center;
    align-items: center;
  }

  .language-switcher:hover,
  .language-switcher.touch-open {
    width: fit-content;
    justify-content: flex-start;
  }

  .lang-btn {
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    font-size: 1.5rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
    position: relative;
  }

  /* Hide non-active buttons by default */
  .lang-btn:not(.active) {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    transform: scale(0.8);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  /* Position inactive buttons when expanded */
  .language-switcher:hover .lang-btn:not(.active),
  .language-switcher.touch-open .lang-btn:not(.active) {
    position: relative;
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
    transition-delay: 0.2s;
  }

  .lang-btn:hover {
    /* border-color removed */
    transform: scale(1.1);
  }

  .lang-btn.active {
    /* border-color removed */
    /* box-shadow removed as requested */
    opacity: 1;
  }

  .flag {
    display: block;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
  }

  .lang-btn:hover .flag,
  .lang-btn.active .flag {
    filter: grayscale(0);
  }
</style>

<script>
  import { languages, defaultLang, type Language } from '../i18n';

  // Get current language from localStorage or use default
  let currentLang: Language = (localStorage.getItem('language') as Language) || defaultLang;

  // Set active button on load
  document.addEventListener('DOMContentLoaded', () => {
    updateActiveButton();
    updatePageContent();
    initTouchSupport();
  });

  function initTouchSupport() {
    const switcher = document.querySelector('.language-switcher');
    
    if (switcher) {
      // Toggle on click (for mobile/touch)
      switcher.addEventListener('click', (e) => {
        // Only toggle if we are not clicking a specific inactive button that is about to fire
        // Actually, just toggling is fine, the button click will handle selection
        // However, we want to prevent toggling CLOSED if we just opened it.
        // Simple logic: click toggles class.
        switcher.classList.toggle('touch-open');
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!switcher.contains(e.target as Node)) {
          switcher.classList.remove('touch-open');
        }
      });

      // Close after scrolling (mobile UX improvement, optional but good)
      window.addEventListener('scroll', () => {
        if (switcher.classList.contains('touch-open')) {
          switcher.classList.remove('touch-open');
        }
      }, { passive: true });
    }
  }

  // Add click listeners to language buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      // Remove stopPropagation to allow bubbling to the container (which handles toggle)
      
      const lang = btn.getAttribute('data-lang') as Language;
      if (lang && lang in languages) {
        // If clicking the already selected language, do nothing specific (bubbling will toggle menu)
        // If changing language, update and allow bubbling to close the menu
        if (currentLang !== lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            updateActiveButton();
            updatePageContent();
        }
      }
    });
  });

  function updateActiveButton() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-lang') === currentLang) {
        btn.classList.add('active');
      }
    });
  }

  function updatePageContent() {
    const t = languages[currentLang];
    
    // Update HTML lang attribute
    document.documentElement.lang = currentLang;

    // Dispatch custom event for components to update
    window.dispatchEvent(new CustomEvent('languageChanged', { 
      detail: { lang: currentLang, translations: t } 
    }));
  }
</script>
